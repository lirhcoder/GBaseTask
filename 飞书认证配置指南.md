# 飞书认证配置指南

## 401 错误原因分析

当出现 "401 (Unauthorized)" 错误时，通常是以下原因之一：

1. **App ID 或 App Secret 错误**
2. **应用权限不足**
3. **多维表格的 App Token 错误**
4. **应用未被授权访问特定的多维表格**

## 解决步骤

### 1. 检查应用凭证

确认 `.env` 文件中的配置正确：
```env
LARK_APP_ID=cli_a8ad6e051b38d02d
LARK_APP_SECRET=CuOlnNl2F7BPNQLi9ZLRNDbuKrvwlaaT
```

### 2. 检查应用权限

登录飞书开放平台，确保应用具有以下权限：

#### 必需权限：
- `bitable:app` - 查看、评论和导出多维表格
- `bitable:app:readonly` - 查看多维表格（只读）
- `bitable:table:data:read` - 读取多维表格数据
- `bitable:table:data:update` - 更新多维表格数据

#### 可选权限（如需要）：
- `auth:user.id:readonly` - 获取用户 ID
- `contact:user.base:readonly` - 获取用户基本信息

### 3. 获取正确的 App Token

App Token 是多维表格的唯一标识，不是表格 ID。获取方法：

1. 打开飞书多维表格
2. 点击右上角的"分享"按钮
3. 选择"高级分享" > "获取链接"
4. URL 格式：`https://xxx.feishu.cn/base/[APP_TOKEN]?table=[TABLE_ID]`
5. 提取 `APP_TOKEN` 部分

### 4. 更新环境变量

```env
# 多维表格配置
LARK_APP_TOKEN=bascnxxxxxx  # 这是 App Token，不是表格 ID
LARK_BUG_TABLE_ID=tbl7w5FyrSAa6yW3
LARK_REQUIREMENT_TABLE_ID=tblWSC6MKpoy782J
```

### 5. 验证权限配置

创建测试脚本验证配置：

```javascript
// test-lark-auth.js
require('dotenv').config();
const LarkClient = require('./src/services/larkClient');

async function testAuth() {
  const client = new LarkClient(
    process.env.LARK_APP_ID,
    process.env.LARK_APP_SECRET
  );
  
  await client.initialize();
  
  try {
    // 测试获取 Bug 表格数据
    const bugData = await client.getTableRecords(
      process.env.LARK_APP_TOKEN,
      process.env.LARK_BUG_TABLE_ID
    );
    console.log('✅ Bug 表格访问成功，记录数:', bugData.items?.length || 0);
  } catch (error) {
    console.error('❌ Bug 表格访问失败:', error.message);
  }
  
  try {
    // 测试获取需求表格数据
    const reqData = await client.getTableRecords(
      process.env.LARK_APP_TOKEN,
      process.env.LARK_REQUIREMENT_TABLE_ID
    );
    console.log('✅ 需求表格访问成功，记录数:', reqData.items?.length || 0);
  } catch (error) {
    console.error('❌ 需求表格访问失败:', error.message);
  }
}

testAuth().catch(console.error);
```

### 6. 应用授权流程

如果应用需要访问特定租户的数据：

1. **管理员授权**
   - 租户管理员需要在飞书管理后台授权应用
   - 路径：管理后台 > 应用管理 > 第三方应用管理

2. **多维表格授权**
   - 确保应用被添加到多维表格的协作者列表中
   - 在多维表格中：设置 > 协作者 > 添加应用

### 7. 常见错误代码

- `99991400` - App ID 或 App Secret 错误
- `99991401` - Token 无效或过期
- `99991403` - 权限不足
- `99991404` - 资源不存在

## 调试建议

1. **启用详细日志**
   修改 `src/services/larkClient.js`，添加详细日志：
   ```javascript
   async getTableRecords(appToken, tableId, viewId = null) {
     console.log('正在获取表格记录:', { appToken, tableId });
     // ... 现有代码
   }
   ```

2. **使用飞书 API 调试工具**
   访问：https://open.feishu.cn/api-explorer/

3. **检查网络代理**
   如果使用企业网络，可能需要配置代理。

## 注意事项

1. **自建应用 vs 商店应用**
   - 确保应用类型设置为"自建应用"（SelfBuild）
   - 商店应用有不同的认证流程

2. **国际版 vs 中国版**
   - 确保 domain 设置正确
   - 中国版：`lark.Domain.Feishu`
   - 国际版：`lark.Domain.Lark`

3. **Token 有效期**
   - App Token 是永久的
   - Access Token 有有效期，需要定期刷新