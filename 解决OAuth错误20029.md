# 解决 Lark OAuth 错误 20029

## 错误描述
错误码：20029 - redirect_uri 请求不合法

## 可能的原因和解决方案

### 1. 重定向 URI 不匹配

**最常见原因**：在 Lark 开发者平台配置的重定向 URI 与实际请求的不完全一致。

**检查要点**：
- ✓ 协议（http vs https）
- ✓ 域名（包括子域名）
- ✓ 端口号（如果非标准端口）
- ✓ 路径（大小写敏感）
- ✓ 末尾是否有斜杠

**您的配置应该是**：
```
https://2b78283dedc6.ngrok-free.app/api/auth/oauth/lark/callback
```

### 2. 配置步骤

#### 步骤 1：运行调试工具
```bash
node debug-oauth-config.js
```

#### 步骤 2：更新 .env 文件
```env
LARK_OAUTH_REDIRECT_URI=https://2b78283dedc6.ngrok-free.app/api/auth/oauth/lark/callback
```

#### 步骤 3：重启服务
```bash
# 停止当前服务 (Ctrl+C)
# 重新启动
npm start
```

#### 步骤 4：在 Lark 开发者平台更新

1. 登录 [Lark 开发者平台](https://open.larksuite.com)
2. 进入您的应用
3. 找到"安全设置"或"OAuth 配置"
4. **删除**旧的重定向 URI
5. **添加**新的重定向 URI（确保完全复制粘贴）：
   ```
   https://2b78283dedc6.ngrok-free.app/api/auth/oauth/lark/callback
   ```
6. 点击保存
7. 等待 challenge 验证通过

### 3. 特殊情况处理

#### ngrok 免费版限制
ngrok 免费版可能在 URL 后面添加额外的路径或参数。检查：

1. 访问 ngrok Web 界面：http://127.0.0.1:4040
2. 查看实际的请求 URL
3. 确认没有额外的路径被添加

#### 如果仍然失败

尝试使用更简单的路径：
1. 在 Lark 平台配置：
   ```
   https://2b78283dedc6.ngrok-free.app/lark-callback
   ```

2. 添加新路由（在 src/routes/auth.js 顶部）：
   ```javascript
   // 简化的回调路由
   router.all('/lark-callback', async (req, res) => {
     const params = { ...req.query, ...req.body };
     const { challenge } = params;
     
     if (challenge) {
       return res.json({ challenge });
     }
     
     // 重定向到主回调处理
     req.url = '/oauth/lark/callback';
     return router.handle(req, res);
   });
   ```

### 4. 验证清单

- [ ] .env 文件中的 LARK_OAUTH_REDIRECT_URI 已更新
- [ ] 服务已重启
- [ ] Lark 平台的重定向 URI 已更新
- [ ] Challenge 验证通过（保存成功）
- [ ] 没有多余的空格或特殊字符
- [ ] URL 中没有端口号（如果使用标准端口）

### 5. 替代方案

如果 ngrok 持续有问题，可以尝试：

1. **使用 localtunnel**
   ```bash
   npm install -g localtunnel
   lt --port 3001 --subdomain lark-oauth-test
   ```

2. **临时部署到云平台**
   - Render.com（免费）
   - Railway.app
   - Heroku

### 6. 调试日志

启用详细日志查看具体错误：
```javascript
// 在 src/routes/auth.js 添加
console.log('OAuth 请求详情:', {
  headers: req.headers,
  query: req.query,
  body: req.body,
  url: req.url,
  originalUrl: req.originalUrl
});
```

### 7. 联系支持

如果以上方法都无效，可以：
1. 提供 Logid: 2025072707055773C8C02539118C0CBF77 给 Lark 支持
2. 说明您使用的是 ngrok 进行本地开发