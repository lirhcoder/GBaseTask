<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lark 数据同步测试 - 自定义端口</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .port-config {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .port-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        input[type="number"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 120px;
        }
        
        button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #1976D2;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .status.online {
            background-color: #4caf50;
            color: white;
        }
        
        .status.offline {
            background-color: #f44336;
            color: white;
        }
        
        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert.info {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .alert.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .alert.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .main-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Lark 数据同步测试 - 自定义端口</h1>
        
        <div class="port-config">
            <h3>服务器配置</h3>
            <div class="port-input">
                <label>服务器端口：</label>
                <input type="number" id="portInput" value="3001" min="1000" max="65535">
                <button onclick="updatePort()">更新端口</button>
                <button onclick="testConnection()">测试连接</button>
                <span id="connectionStatus" class="status offline">未连接</span>
            </div>
            <div id="portMessage"></div>
        </div>
        
        <div id="mainContent" class="main-content hidden">
            <h3>连接成功！</h3>
            <p>服务器运行在端口 <strong id="currentPort">3001</strong></p>
            <br>
            <button onclick="openFullTest()">打开完整测试页面</button>
            <button onclick="loadTestPage()">在此页面加载测试功能</button>
        </div>
        
        <div id="testContainer"></div>
    </div>
    
    <script>
        let currentPort = localStorage.getItem('apiPort') || '3001';
        document.getElementById('portInput').value = currentPort;
        
        // 页面加载时自动测试连接
        window.onload = function() {
            testConnection();
        };
        
        function updatePort() {
            const port = document.getElementById('portInput').value;
            if (port < 1000 || port > 65535) {
                showMessage('请输入有效的端口号 (1000-65535)', 'error');
                return;
            }
            
            currentPort = port;
            localStorage.setItem('apiPort', port);
            showMessage(`端口已更新为 ${port}`, 'success');
            testConnection();
        }
        
        async function testConnection() {
            const port = document.getElementById('portInput').value;
            const statusEl = document.getElementById('connectionStatus');
            const mainContent = document.getElementById('mainContent');
            
            statusEl.textContent = '连接中...';
            statusEl.className = 'status offline';
            
            try {
                const response = await fetch(`http://localhost:${port}/api/tasks`, {
                    method: 'GET',
                    headers: {
                        'Authorization': localStorage.getItem('authToken') || ''
                    }
                });
                
                if (response.ok || response.status === 401) {
                    statusEl.textContent = '在线';
                    statusEl.className = 'status online';
                    mainContent.classList.remove('hidden');
                    document.getElementById('currentPort').textContent = port;
                    showMessage(`成功连接到端口 ${port}`, 'success');
                } else {
                    throw new Error('服务器响应错误');
                }
            } catch (error) {
                statusEl.textContent = '离线';
                statusEl.className = 'status offline';
                mainContent.classList.add('hidden');
                showMessage(`无法连接到端口 ${port}，请确保服务器正在运行`, 'error');
            }
        }
        
        function showMessage(message, type = 'info') {
            const messageEl = document.getElementById('portMessage');
            messageEl.className = `alert ${type}`;
            messageEl.textContent = message;
            setTimeout(() => {
                messageEl.textContent = '';
                messageEl.className = '';
            }, 3000);
        }
        
        function openFullTest() {
            // 创建一个新的测试页面，使用当前端口
            const testUrl = `test-lark-sync.html`;
            
            // 在新窗口打开前，先设置端口
            localStorage.setItem('apiPort', currentPort);
            
            // 打开测试页面
            window.open(testUrl, '_blank');
            
            showMessage('已在新窗口打开测试页面', 'info');
        }
        
        function loadTestPage() {
            const container = document.getElementById('testContainer');
            container.innerHTML = `
                <div style="margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                    <h3>正在加载测试功能...</h3>
                    <p>API 地址: http://localhost:${currentPort}/api</p>
                    <br>
                    <iframe 
                        src="test-lark-sync.html" 
                        style="width: 100%; height: 800px; border: 1px solid #ddd; border-radius: 4px;"
                        onload="updateIframePort(this)"
                    ></iframe>
                </div>
            `;
        }
        
        function updateIframePort(iframe) {
            // 尝试更新 iframe 中的端口设置
            try {
                const iframeWindow = iframe.contentWindow;
                if (iframeWindow && iframeWindow.localStorage) {
                    iframeWindow.localStorage.setItem('apiPort', currentPort);
                    showMessage('测试页面已加载，使用端口 ' + currentPort, 'success');
                }
            } catch (e) {
                console.log('无法访问 iframe 内容，可能是跨域限制');
            }
        }
    </script>
</body>
</html>