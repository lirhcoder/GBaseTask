# Lark 任务管理系统部署指南

## 本地开发环境

### 前置要求
- Node.js 18+ 
- MongoDB 4.0+
- 飞书应用凭证（App ID 和 App Secret）

### 安装步骤

1. **克隆项目**
```bash
git clone https://github.com/lirhcoder/GBaseTask.git
cd GBaseTask
```

2. **安装依赖**
```bash
npm install
```

3. **配置环境变量**
```bash
cp .env.example .env
# 编辑 .env 文件，填入你的配置
```

4. **启动 MongoDB**
```bash
# macOS/Linux
mongod --dbpath /path/to/data

# Windows
mongod.exe --dbpath C:\data\db
```

5. **启动应用**
```bash
# 开发模式
npm run dev

# 生产模式
npm start
```

## 生产环境部署

### 使用 PM2

1. **安装 PM2**
```bash
npm install -g pm2
```

2. **创建 ecosystem 配置**
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'lark-task-system',
    script: './src/index.js',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};
```

3. **启动应用**
```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

### 使用 Docker

1. **创建 Dockerfile**
```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["node", "src/index.js"]
```

2. **创建 docker-compose.yml**
```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=mongodb://mongo:27017/lark-task-system
    depends_on:
      - mongo
    restart: unless-stopped

  mongo:
    image: mongo:5
    volumes:
      - mongo-data:/data/db
    restart: unless-stopped

volumes:
  mongo-data:
```

3. **部署**
```bash
docker-compose up -d
```

### 使用云服务

#### 阿里云 ECS

1. **准备服务器**
   - 推荐配置：2核4G
   - 操作系统：Ubuntu 20.04 LTS

2. **安装环境**
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装 MongoDB
wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/5.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-5.0.list
sudo apt-get update
sudo apt-get install -y mongodb-org
sudo systemctl start mongod
sudo systemctl enable mongod

# 安装 PM2
sudo npm install -g pm2
```

3. **部署应用**
```bash
# 克隆代码
git clone https://github.com/lirhcoder/GBaseTask.git
cd GBaseTask

# 安装依赖
npm install

# 配置环境变量
cp .env.example .env
nano .env  # 编辑配置

# 启动应用
pm2 start ecosystem.config.js
```

#### 腾讯云

使用腾讯云 Serverless 应用中心：

1. 安装 Serverless CLI
```bash
npm install -g serverless
```

2. 创建 `serverless.yml`
```yaml
component: express
name: lark-task-system
app: lark-task

inputs:
  src:
    src: ./
    exclude:
      - .env*
      - node_modules/**
  region: ap-guangzhou
  runtime: Nodejs16.13
  apigatewayConf:
    protocols:
      - https
  environment:
    variables:
      NODE_ENV: production
```

3. 部署
```bash
serverless deploy
```

## 配置说明

### 环境变量

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| LARK_APP_ID | 飞书应用 ID | cli_xxx |
| LARK_APP_SECRET | 飞书应用密钥 | xxx |
| LARK_BUG_TABLE_ID | Bug 表格 ID | tblxxx |
| LARK_REQUIREMENT_TABLE_ID | 需求表格 ID | tblxxx |
| DATABASE_URL | MongoDB 连接字符串 | mongodb://localhost:27017/lark-task |
| PORT | 服务端口 | 3000 |
| NODE_ENV | 运行环境 | production |
| AUTO_SYNC | 是否自动同步 | true |

### Nginx 反向代理配置

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 监控和日志

### 使用 PM2 监控

```bash
# 查看应用状态
pm2 status

# 查看日志
pm2 logs

# 监控面板
pm2 monit
```

### 日志管理

1. **配置日志轮转**
```bash
# /etc/logrotate.d/lark-task
/path/to/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0640 node node
}
```

2. **集成日志服务**
   - 阿里云 SLS
   - 腾讯云 CLS
   - ELK Stack

## 性能优化

### 数据库优化

1. **创建索引**
```javascript
// 在 MongoDB 中执行
db.tasks.createIndex({ status: 1 });
db.tasks.createIndex({ assignee: 1 });
db.tasks.createIndex({ sourceId: 1, sourceType: 1 });
db.tasks.createIndex({ createdAt: -1 });
```

2. **连接池配置**
```javascript
mongoose.connect(dbUrl, {
  maxPoolSize: 10,
  minPoolSize: 2,
  socketTimeoutMS: 45000,
});
```

### 应用优化

1. **启用压缩**
```javascript
const compression = require('compression');
app.use(compression());
```

2. **设置缓存**
```javascript
app.use((req, res, next) => {
  if (req.method === 'GET') {
    res.set('Cache-Control', 'public, max-age=300');
  }
  next();
});
```

## 故障排查

### 常见问题

1. **数据库连接失败**
   - 检查 MongoDB 服务状态
   - 验证连接字符串
   - 检查防火墙规则

2. **飞书 API 调用失败**
   - 验证 App ID 和 Secret
   - 检查应用权限
   - 查看 API 调用限制

3. **内存泄漏**
   - 使用 `pm2 monit` 监控内存
   - 启用 heapdump 分析
   - 检查事件监听器

### 健康检查脚本

```bash
#!/bin/bash
# health-check.sh

HEALTH_URL="http://localhost:3000/health"
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)

if [ $RESPONSE -eq 200 ]; then
    echo "Service is healthy"
    exit 0
else
    echo "Service is unhealthy (HTTP $RESPONSE)"
    exit 1
fi
```

## 备份和恢复

### 数据库备份

```bash
# 备份
mongodump --db lark-task-system --out /backup/$(date +%Y%m%d)

# 恢复
mongorestore --db lark-task-system /backup/20240101
```

### 自动备份脚本

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backup"
DB_NAME="lark-task-system"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份
mongodump --db $DB_NAME --out $BACKUP_DIR/$DATE

# 删除7天前的备份
find $BACKUP_DIR -type d -mtime +7 -exec rm -rf {} \;

# 上传到云存储（可选）
# aws s3 sync $BACKUP_DIR s3://your-bucket/mongodb-backup/
```

添加到 crontab：
```bash
0 2 * * * /path/to/backup.sh
```

## 安全建议

1. **使用 HTTPS**
   - 申请 SSL 证书
   - 配置 Nginx SSL

2. **API 认证**
   - 实现 JWT 认证
   - 添加 API 密钥管理

3. **限流保护**
   - 使用 express-rate-limit
   - 配置 Nginx 限流

4. **环境变量安全**
   - 使用密钥管理服务
   - 避免在代码中硬编码

5. **定期更新依赖**
   ```bash
   npm audit
   npm update
   ```